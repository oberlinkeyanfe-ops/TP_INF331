{% extends "base.html" %}
{% block title %}Chatbot Intelligent{% endblock %}

{% block content %}
<div class="container">
    <h2>ü§ñ Chatbot Intelligent</h2>
    
    {% if not GEMINI_AVAILABLE %}
    <div class="alert warning" style="background: #fff3cd; border-color: #ffeaa7; color: #856404;">
        <strong>‚ö†Ô∏è Attention:</strong> Le chatbot avanc√© n'est pas disponible. 
        <a href="https://pypi.org/project/google-generativeai/" target="_blank">Installez Google Generative AI</a> pour activer les fonctionnalit√©s intelligentes.
    </div>
    {% endif %}

    <div class="card">
        <div class="chatbot-container">
            <!-- En-t√™te du chat -->
            <div class="chat-header">
                <h3>üí¨ Assistant Aviculture</h3>
                <p>Posez-moi des questions sur vos bandes, co√ªts, consommations...</p>
            </div>

            <!-- Zone des messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <strong>Assistant:</strong>
                        <p>Bonjour ! üëã Je suis votre assistant pour la gestion avicole. Posez-moi des questions comme :</p>
                        <ul>
                            <li>"Quel est le co√ªt total de la bande 1 ?"</li>
                            <li>"Combien d'aliment a consomm√© la bande 2 cette semaine ?"</li>
                            <li>"Quels sont les traitements r√©cents ?"</li>
                            <li>"Compare les d√©penses des bandes actives"</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Zone de saisie -->
            <div class="chat-input-container">
                <div class="input-group">
                    <input type="text" id="messageInput" 
                           placeholder="Tapez votre question ici... Ex: Quel est le co√ªt de la bande 1 ?" 
                           class="message-input">
                    <button onclick="envoyerMessage()" class="send-button">
                        <span>üì§</span> Envoyer
                    </button>
                </div>
                
                <!-- Suggestions rapides -->
                <div class="suggestions">
                    <small>üí° Questions rapides :</small>
                    <div class="suggestion-buttons">
                        <button onclick="suggestion('Quel est le co√ªt total de mes bandes ?')" class="suggestion-btn">
                            Co√ªt total
                        </button>
                        <button onclick="suggestion('Quelle bande consomme le plus d\'aliment ?')" class="suggestion-btn">
                            Consommation
                        </button>
                        <button onclick="suggestion('Quels sont les traitements r√©cents ?')" class="suggestion-btn">
                            Traitements
                        </button>
                        <button onclick="suggestion('Quelle bande a le meilleur rendement ?')" class="suggestion-btn">
                            Performance
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chatbot-container {
    display: flex;
    flex-direction: column;
    height: 70vh;
}

.chat-header {
    text-align: center;
    padding: 1rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 10px 10px 0 0;
    margin: -1.5rem -1.5rem 1rem -1.5rem;
}

.chat-header h3 {
    margin: 0;
    font-size: 1.5rem;
}

.chat-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 1rem;
    max-height: 400px;
    border: 1px solid #e9ecef;
}

.message {
    display: flex;
    margin-bottom: 1rem;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-message {
    justify-content: flex-end;
}

.bot-message {
    justify-content: flex-start;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin: 0 0.5rem;
    flex-shrink: 0;
}

.user-message .message-avatar {
    background: #007bff;
    color: white;
    order: 2;
}

.bot-message .message-avatar {
    background: #28a745;
    color: white;
}

.message-content {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 15px;
    position: relative;
}

.user-message .message-content {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 5px;
}

.bot-message .message-content {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 5px;
}

.message-content strong {
    display: block;
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
    opacity: 0.8;
}

.message-content p {
    margin: 0;
    line-height: 1.4;
}

.message-content ul {
    margin: 0.5rem 0;
    padding-left: 1rem;
}

.message-content li {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.chat-input-container {
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
}

.input-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.message-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s;
}

.message-input:focus {
    border-color: #007bff;
}

.send-button {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.send-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.send-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.suggestions {
    margin-top: 1rem;
}

.suggestions small {
    color: #6c757d;
    display: block;
    margin-bottom: 0.5rem;
}

.suggestion-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.suggestion-btn {
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s;
    color: #495057;
}

.suggestion-btn:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
    transform: translateY(-1px);
}

/* Scrollbar personnalis√©e */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Responsive */
@media (max-width: 768px) {
    .message-content {
        max-width: 85%;
    }
    
    .suggestion-buttons {
        flex-direction: column;
    }
    
    .suggestion-btn {
        text-align: center;
    }
    
    .chatbot-container {
        height: 60vh;
    }
}
</style>

<script>
// Fonction pour afficher un message
function afficherMessage(utilisateur, bot, estUtilisateur = true) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (estUtilisateur) {
        // Message utilisateur
        const userMsg = document.createElement('div');
        userMsg.className = 'message user-message';
        userMsg.innerHTML = `
            <div class="message-content">
                ${utilisateur}
            </div>
            <div class="message-avatar">üë§</div>
        `;
        chatMessages.appendChild(userMsg);
    }
    
    // Message bot
    const botMsg = document.createElement('div');
    botMsg.className = 'message bot-message';
    botMsg.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
            <strong>Assistant:</strong>
            <p>${bot}</p>
        </div>
    `;
    chatMessages.appendChild(botMsg);
    
    // Scroll vers le bas
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Fonction pour envoyer un message
async function envoyerMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) {
        alert('Veuillez taper un message');
        return;
    }
    
    // D√©sactiver le bouton pendant l'envoi
    const sendButton = document.querySelector('.send-button');
    sendButton.disabled = true;
    sendButton.innerHTML = '<span>‚è≥</span> Envoi...';
    
    // Afficher le message utilisateur imm√©diatement
    afficherMessage(message, '', true);
    messageInput.value = '';
    
    try {
        const response = await fetch('/chatbot/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({message: message})
        });
        
        const data = await response.json();
        
        if (response.ok) {
            afficherMessage('', data.reponse, false);
        } else {
            afficherMessage('', `‚ùå Erreur: ${data.error}`, false);
        }
        
    } catch (error) {
        afficherMessage('', `‚ùå Erreur de connexion: ${error}`, false);
    } finally {
        // R√©activer le bouton
        sendButton.disabled = false;
        sendButton.innerHTML = '<span>üì§</span> Envoyer';
    }
}

// Fonction pour les suggestions
function suggestion(texte) {
    document.getElementById('messageInput').value = texte;
    document.getElementById('messageInput').focus();
}

// Envoyer avec la touche Entr√©e
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        envoyerMessage();
    }
});

// Focus automatique sur l'input
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('messageInput').focus();
});

// Fonction pour effacer l'historique (optionnel)
function effacerHistorique() {
    if (confirm('Voulez-vous effacer l\'historique de la conversation ?')) {
        document.getElementById('chatMessages').innerHTML = `
            <div class="message bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <strong>Assistant:</strong>
                    <p>Conversation effac√©e. Comment puis-je vous aider ?</p>
                </div>
            </div>
        `;
    }
}
</script>

<div style="text-align: center; margin-top: 1rem;">
    <button onclick="effacerHistorique()" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
        üóëÔ∏è Effacer l'historique
    </button>
</div>
{% endblock %}