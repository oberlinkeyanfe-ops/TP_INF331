{% extends "base.html" %}
{% block title %}Gestion des Animaux{% endblock %}

{% block content %}
<div class="container">
    <h2>Gestion des Animaux</h2>
    
    <!-- Menu des fonctions -->
    <div class="functions-menu">
        <button id="btn-ajouter" class="function-btn active">‚ûï Ajouter des Animaux</button>
        <button id="btn-liste" class="function-btn">üìã Liste des Animaux</button>
        <button id="btn-par-bande" class="function-btn">üè∑Ô∏è Animaux par Bande</button>
        <button id="btn-statistiques" class="function-btn">üìä Statistiques</button>
        <button id="btn-rechercher" class="function-btn">üîç Rechercher</button>
    </div>

    <!-- Messages flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div style="margin: 1rem 0;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Debug console -->
    <div id="debugConsole" style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; display: none;">
        <strong>Debug Console:</strong>
        <div id="debugContent"></div>
    </div>

    <!-- Section Ajouter -->
    <div id="ajouter" class="function-section active">
        <div class="card">
            <h3>Ajouter des Animaux √† une Bande</h3>
            <form method="POST" action="{{ url_for('animaux.create_animal') }}" id="animalForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Bande *</label>
                        <select name="bande_id" required onchange="updateBandeInfo(this.value)">
                            <option value="">S√©lectionner une bande</option>
                            {% for bande in bandes %}
                            <option value="{{ bande.id }}" 
                                    data-nom="{{ bande.nom_bande }}" 
                                    data-race="{{ bande.race or 'Race non sp√©cifi√©e' }}" 
                                    data-initial="{{ bande.nombre_initial }}"
                                    data-ajoute="{{ bande.nbre_ajoute }}"
                                    data-statut="{{ bande.statut }}">
                                {{ bande.nom_bande }} - {{ bande.race or 'Race non sp√©cifi√©e' }} 
                                (Initial: {{ bande.nombre_initial }}, Ajout√©s: {{ bande.nbre_ajoute }})
                            </option>
                            {% endfor %}
                        </select>
                        <small id="bande-info" style="color: #666; margin-top: 0.5rem; display: none;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label>√âtat d'achat *</label>
                        <select name="etat_achat" required onchange="togglePrixField()">
                            <option value="achet√©">Achet√©</option>
                            <option value="n√©">N√© dans l'√©levage</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>√âtat de sant√© *</label>
                        <select name="etat" required id="etatSelect">
                            <option value="sain">Sain</option>
                            <option value="malade">Malade</option>
                            <option value="mort">Mort</option>
                            <option value="disparu">Disparu</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="number" name="nombre" placeholder="Nombre d'animaux" required min="1" value="1" id="nombreInput">
                    </div>
                    
                    <div class="form-group" id="prixField">
                        <label>Prix unitaire (FCFA)</label>
                        <input type="number" name="prix" placeholder="Prix par animal" step="0.01" min="0" value="0" id="prixInput">
                    </div>
                    
                    <div class="form-group">
                        <label>√Çge (jours)</label>
                        <input type="number" name="age" placeholder="√Çge en jours" step="0.1" min="0" id="ageInput">
                    </div>
                    
                    <div class="form-group">
                        <label>Poids moyen (kg)</label>
                        <input type="number" name="poids" placeholder="Poids moyen en kg" step="0.01" min="0" id="poidsInput">
                    </div>
                    
                    <div class="form-group">
                        <label>Date de naissance</label>
                        <input type="date" name="date_naissance" id="dateNaissanceInput" value="{{ today }}">
                    </div>
                </div>
                
                <div id="prix-total" style="margin: 1rem 0; padding: 1rem; background: #e7f3ff; border-radius: 5px; display: none;">
                    <strong>Prix total estim√©: <span id="prix-total-value">0</span> FCFA</strong>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">‚ûï Ajouter √† la Bande</button>
                    <button type="reset" class="btn btn-secondary">üîÑ R√©initialiser</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Section Liste -->
    <div id="liste" class="function-section">
        <div class="card">
            <div class="card-header">
                <h3>Liste de Tous les Animaux (<span id="totalAnimaux">0</span> enregistrements)</h3>
                <div>
                    <button onclick="loadListeAnimaux()" class="btn btn-outline-primary">üîÑ Actualiser</button>
                    <button onclick="exportAnimauxToExcel()" class="btn btn-info">üìä Exporter Excel</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="animauxTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bande</th>
                            <th>√âtat Achat</th>
                            <th>√âtat Sant√©</th>
                            <th>Nombre</th>
                            <th>Prix Unitaire</th>
                            <th>Prix Total</th>
                            <th>√Çge</th>
                            <th>Poids</th>
                            <th>Date Ajout</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="animauxTableBody">
                        <!-- Les donn√©es seront charg√©es dynamiquement -->
                    </tbody>
                </table>
            </div>
            <div id="listeLoading" class="loading" style="display: none;">
                <p>Chargement des animaux...</p>
            </div>
        </div>
    </div>

    <!-- Section Animaux par Bande -->
    <div id="par_bande" class="function-section">
        <div class="card">
            <div class="card-header">
                <h3>Animaux par Bande</h3>
                <button onclick="loadAnimauxParBande()" class="btn btn-outline-primary">üîÑ Actualiser</button>
            </div>
            
            <div id="bandesContainer">
                <!-- Les donn√©es seront charg√©es dynamiquement -->
            </div>
            <div id="bandesLoading" class="loading" style="display: none;">
                <p>Chargement des bandes...</p>
            </div>
        </div>
    </div>

    <!-- Section Statistiques -->
    <div id="statistiques" class="function-section">
        <div class="card">
            <div class="card-header">
                <h3>Statistiques des Animaux</h3>
                <button onclick="loadStatistiques()" class="btn btn-outline-primary">üîÑ Actualiser</button>
            </div>
            
            <div id="statsContainer">
                <!-- Les statistiques seront charg√©es dynamiquement -->
            </div>
            <div id="statsLoading" class="loading" style="display: none;">
                <p>Chargement des statistiques...</p>
            </div>
        </div>
    </div>

    <!-- Section Rechercher -->
    <div id="rechercher" class="function-section">
        <div class="card">
            <h3>Rechercher des Animaux</h3>
            <div class="search-container">
                <input type="text" id="searchAnimalInput" placeholder="Rechercher par bande, √©tat, race, etc..." class="search-input">
                <button onclick="searchAnimaux()" class="btn btn-primary">üîç Rechercher</button>
            </div>
            <div id="searchAnimalResults" class="search-results">
                <!-- Les r√©sultats de recherche seront affich√©s ici -->
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les d√©tails de l'animal -->
<div id="animalModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>D√©tails de l'Animal</h3>
        <div id="animalModalContent"></div>
    </div>
</div>

<!-- Modal pour l'√©dition -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>Modifier l'Animal</h3>
        <div id="editModalContent">
            <!-- Le formulaire d'√©dition sera charg√© ici -->
        </div>
    </div>
</div>

<style>
.functions-menu {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.function-btn {
    padding: 0.75rem 1.5rem;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
}

.function-btn:hover {
    background: #e9ecef;
    border-color: #007bff;
}

.function-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.function-section {
    display: none;
}

.function-section.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.bande-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.bande-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.bande-info {
    margin-bottom: 1rem;
    padding: 0.5rem;
    background: white;
    border-radius: 5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    border-left: 4px solid #007bff;
}

.stat-card h4 {
    margin: 0 0 0.5rem 0;
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
}

.stat-card .stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #007bff;
}

.bande-stats {
    margin: 1rem 0;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 5px;
    text-align: center;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-sain {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-malade {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-mort {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-disparu {
    background: #e2e3e5;
    color: #383d41;
    border: 1px solid #d6d8db;
}

.status-achat-achet√© {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.status-achat-n√© {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-achat-autre {
    background: #e2e3e5;
    color: #383d41;
    border: 1px solid #d6d8db;
}

.actions {
    display: flex;
    gap: 0.25rem;
    flex-wrap: nowrap;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.no-data {
    color: #666;
    text-align: center;
    padding: 2rem;
    font-style: italic;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.search-container {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.search-input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

.search-results {
    margin-top: 1rem;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animal-row:hover {
    background-color: #f8f9fa;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 1rem;
    border-radius: 5px;
    margin: 1rem 0;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 1rem;
    border-radius: 5px;
    margin: 1rem 0;
}
</style>

<script>
// Variables globales
let currentAnimalId = null;

// Fonction de debug
function debug(message) {
    console.log('DEBUG:', message);
    const debugConsole = document.getElementById('debugConsole');
    const debugContent = document.getElementById('debugContent');
    if (debugConsole && debugContent) {
        debugConsole.style.display = 'block';
        debugContent.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
    }
}

// Fonction pour afficher les sections
function showSection(sectionId) {
    debug('showSection appel√©e avec: ' + sectionId);
    
    // Masquer toutes les sections
    document.querySelectorAll('.function-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // D√©sactiver tous les boutons
    document.querySelectorAll('.function-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Afficher la section demand√©e
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
        debug('Section ' + sectionId + ' affich√©e');
    } else {
        debug('ERREUR: Section ' + sectionId + ' non trouv√©e');
    }
    
    // Activer le bouton correspondant
    const activeBtn = document.getElementById('btn-' + sectionId);
    if (activeBtn) {
        activeBtn.classList.add('active');
        debug('Bouton ' + sectionId + ' activ√©');
    } else {
        debug('ERREUR: Bouton btn-' + sectionId + ' non trouv√©');
    }
}

// Test simple des sections
function testSections() {
    debug('=== TEST DES SECTIONS ===');
    showSection('liste');
    setTimeout(() => showSection('par_bande'), 1000);
    setTimeout(() => showSection('statistiques'), 2000);
    setTimeout(() => showSection('rechercher'), 3000);
    setTimeout(() => showSection('ajouter'), 4000);
}

// Charger la liste des animaux
async function loadListeAnimaux() {
    debug('loadListeAnimaux appel√©e');
    showSection('liste');
    
    const tableBody = document.getElementById('animauxTableBody');
    const loadingDiv = document.getElementById('listeLoading');
    const totalSpan = document.getElementById('totalAnimaux');
    
    if (!tableBody) {
        debug('ERREUR: animauxTableBody non trouv√©');
        return;
    }
    
    tableBody.innerHTML = '';
    loadingDiv.style.display = 'block';
    
    try {
        debug('Tentative de fetch /animaux/api/liste');
        const response = await fetch('/animaux/api/liste');
        debug('R√©ponse re√ßue, status: ' + response.status);
        
        if (!response.ok) {
            throw new Error('Erreur HTTP: ' + response.status);
        }
        
        const data = await response.json();
        debug('Donn√©es re√ßues: ' + (data.animaux ? data.animaux.length + ' animaux' : 'aucune donn√©e'));
        
        if (data.animaux && data.animaux.length > 0) {
            let html = '';
            data.animaux.forEach(animal => {
                html += `
                    <tr data-animal-id="${animal.id}" class="animal-row">
                        <td>${animal.id}</td>
                        <td><strong>${animal.bande_nom || 'N/A'}</strong></td>
                        <td><span class="status-badge status-achat-${animal.etat_achat}">${animal.etat_achat}</span></td>
                        <td><span class="status-badge status-${animal.etat}">${animal.etat}</span></td>
                        <td>${animal.nombre}</td>
                        <td>${animal.prix ? animal.prix.toFixed(2) : '0.00'} FCFA</td>
                        <td><strong>${animal.prix_total ? animal.prix_total.toFixed(2) : '0.00'} FCFA</strong></td>
                        <td>${animal.age || 'N/A'} jours</td>
                        <td>${animal.poids || 'N/A'} kg</td>
                        <td>${animal.created_at ? new Date(animal.created_at).toLocaleDateString('fr-FR') : 'N/A'}</td>
                        <td class="actions">
                            <button onclick="editAnimal(${animal.id})" class="btn btn-warning btn-sm">‚úèÔ∏è</button>
                            <button onclick="showAnimalDetails(${animal.id})" class="btn btn-info btn-sm">üëÅÔ∏è</button>
                            <button onclick="deleteAnimal(${animal.id})" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
            totalSpan.textContent = data.animaux.length;
            debug('Tableau rempli avec ' + data.animaux.length + ' animaux');
        } else {
            tableBody.innerHTML = '<tr><td colspan="11" class="no-data">Aucun animal enregistr√©</td></tr>';
            totalSpan.textContent = '0';
            debug('Aucun animal trouv√©');
        }
    } catch (error) {
        debug('ERREUR dans loadListeAnimaux: ' + error.message);
        tableBody.innerHTML = `<tr><td colspan="11" class="error-message">Erreur: ${error.message}</td></tr>`;
        totalSpan.textContent = '0';
    } finally {
        loadingDiv.style.display = 'none';
        debug('Chargement termin√©');
    }
}

// Charger les animaux par bande
async function loadAnimauxParBande() {
    debug('loadAnimauxParBande appel√©e');
    showSection('par_bande');
    
    const container = document.getElementById('bandesContainer');
    const loadingDiv = document.getElementById('bandesLoading');
    
    if (!container) {
        debug('ERREUR: bandesContainer non trouv√©');
        return;
    }
    
    container.innerHTML = '';
    loadingDiv.style.display = 'block';
    
    try {
        debug('Tentative de fetch /bandes/search?q=');
        const bandesResponse = await fetch('/bandes/search?q=');
        debug('R√©ponse bandes re√ßue, status: ' + bandesResponse.status);
        
        if (!bandesResponse.ok) {
            throw new Error('Erreur lors du chargement des bandes: ' + bandesResponse.status);
        }
        
        const bandes = await bandesResponse.json();
        debug(bandes.length + ' bandes trouv√©es');
        
        if (bandes.length === 0) {
            container.innerHTML = '<p class="no-data">Aucune bande trouv√©e</p>';
            return;
        }
        
        let html = '';
        
        for (const bande of bandes) {
            debug('Chargement des animaux pour bande: ' + bande.id);
            const animauxResponse = await fetch(`/animaux/api/bande/${bande.id}`);
            const animauxData = await animauxResponse.json();
            
            html += `
                <div class="bande-section">
                    <div class="bande-header">
                        <h4>üè∑Ô∏è ${bande.nom_bande} - ${bande.race || 'Race non sp√©cifi√©e'}</h4>
                        <button onclick="loadBandeStatistiques(${bande.id})" class="btn btn-sm btn-outline-primary">üìä Stats d√©taill√©es</button>
                    </div>
                    <div class="bande-info">
                        <strong>Animaux initiaux:</strong> ${bande.nombre_initial} | 
                        <strong>Animaux ajout√©s:</strong> ${bande.nbre_ajoute} |
                        <strong>Total:</strong> ${bande.nombre_initial + bande.nbre_ajoute} |
                        <strong>Statut:</strong> <span class="status-badge status-${bande.statut}">${bande.statut}</span>
                    </div>
            `;
            
            if (animauxData.animaux && animauxData.animaux.length > 0) {
                html += `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>√âtat Achat</th>
                                    <th>√âtat Sant√©</th>
                                    <th>Nombre</th>
                                    <th>Prix Unitaire</th>
                                    <th>Prix Total</th>
                                    <th>√Çge</th>
                                    <th>Date Ajout</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                animauxData.animaux.forEach(animal => {
                    html += `
                        <tr>
                            <td><span class="status-badge status-achat-${animal.etat_achat}">${animal.etat_achat}</span></td>
                            <td><span class="status-badge status-${animal.etat}">${animal.etat}</span></td>
                            <td>${animal.nombre}</td>
                            <td>${animal.prix ? animal.prix.toFixed(2) : '0.00'} FCFA</td>
                            <td><strong>${animal.prix_total ? animal.prix_total.toFixed(2) : '0.00'} FCFA</strong></td>
                            <td>${animal.age || 'N/A'} jours</td>
                            <td>${animal.created_at ? new Date(animal.created_at).toLocaleDateString('fr-FR') : 'N/A'}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            } else {
                html += '<p class="no-data">Aucun animal ajout√© √† cette bande</p>';
            }
            
            html += '</div>';
        }
        
        container.innerHTML = html;
        debug('Contenu bandes affich√©');
        
    } catch (error) {
        debug('ERREUR dans loadAnimauxParBande: ' + error.message);
        container.innerHTML = `<div class="error-message">Erreur: ${error.message}</div>`;
    } finally {
        loadingDiv.style.display = 'none';
    }
}

// Charger les statistiques
async function loadStatistiques() {
    debug('loadStatistiques appel√©e');
    showSection('statistiques');
    
    const container = document.getElementById('statsContainer');
    const loadingDiv = document.getElementById('statsLoading');
    
    if (!container) {
        debug('ERREUR: statsContainer non trouv√©');
        return;
    }
    
    container.innerHTML = '';
    loadingDiv.style.display = 'block';
    
    try {
        debug('Tentative de fetch /animaux/api/statistiques/generales');
        const response = await fetch('/animaux/api/statistiques/generales');
        debug('R√©ponse stats re√ßue, status: ' + response.status);
        
        if (!response.ok) {
            throw new Error('Erreur lors du chargement des statistiques: ' + response.status);
        }
        
        const stats = await response.json();
        debug('Statistiques re√ßues');
        
        if (stats.total_animaux === 0) {
            container.innerHTML = '<p class="no-data">Aucune donn√©e statistique disponible</p>';
            return;
        }
        
        let html = `
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Animaux</h4>
                    <span class="stat-number">${stats.total_animaux}</span>
                </div>
                <div class="stat-card">
                    <h4>Co√ªt Total</h4>
                    <span class="stat-number">${stats.cout_total} FCFA</span>
                </div>
                <div class="stat-card">
                    <h4>Co√ªt Moyen</h4>
                    <span class="stat-number">${stats.cout_moyen_par_animal} FCFA</span>
                </div>
                <div class="stat-card">
                    <h4>Bandes avec Animaux</h4>
                    <span class="stat-number">${stats.nombre_bandes_avec_animaux}</span>
                </div>
                <div class="stat-card">
                    <h4>Enregistrements</h4>
                    <span class="stat-number">${stats.nombre_enregistrements}</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        debug('Statistiques affich√©es');
        
    } catch (error) {
        debug('ERREUR dans loadStatistiques: ' + error.message);
        container.innerHTML = `<div class="error-message">Erreur: ${error.message}</div>`;
    } finally {
        loadingDiv.style.display = 'none';
    }
}

// Recherche d'animaux
async function searchAnimaux() {
    debug('searchAnimaux appel√©e');
    showSection('rechercher');
    const searchTerm = document.getElementById('searchAnimalInput').value;
    const resultsDiv = document.getElementById('searchAnimalResults');
    
    if (!searchTerm) {
        resultsDiv.innerHTML = '<p class="no-data">Veuillez entrer un terme de recherche</p>';
        return;
    }
    
    resultsDiv.innerHTML = '<p>Recherche en cours...</p>';
    
    try {
        debug('Recherche avec terme: ' + searchTerm);
        const response = await fetch(`/animaux/api/rechercher?q=${encodeURIComponent(searchTerm)}`);
        debug('R√©ponse recherche re√ßue, status: ' + response.status);
        
        if (!response.ok) {
            throw new Error('Erreur lors de la recherche: ' + response.status);
        }
        
        const data = await response.json();
        debug('R√©sultats recherche: ' + data.total + ' trouv√©s');
        
        if (data.animaux && data.animaux.length > 0) {
            let html = `
                <div class="success-message">
                    ${data.total} r√©sultat(s) trouv√©(s) pour "${data.search_term}"
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Bande</th>
                                <th>√âtat Achat</th>
                                <th>√âtat Sant√©</th>
                                <th>Nombre</th>
                                <th>Prix Total</th>
                                <th>√Çge</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.animaux.forEach(animal => {
                html += `
                    <tr>
                        <td>${animal.id}</td>
                        <td>${animal.bande_nom}</td>
                        <td><span class="status-badge status-achat-${animal.etat_achat}">${animal.etat_achat}</span></td>
                        <td><span class="status-badge status-${animal.etat}">${animal.etat}</span></td>
                        <td>${animal.nombre}</td>
                        <td>${animal.prix_total ? animal.prix_total.toFixed(2) : '0.00'} FCFA</td>
                        <td>${animal.age || 'N/A'} jours</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `<p class="no-data">Aucun r√©sultat trouv√© pour "${data.search_term}"</p>`;
        }
    } catch (error) {
        debug('ERREUR dans searchAnimaux: ' + error.message);
        resultsDiv.innerHTML = `<div class="error-message">Erreur: ${error.message}</div>`;
    }
}

// Les autres fonctions restent inchang√©es...
function calculerPrixTotal() {
    const nombre = parseInt(document.getElementById('nombreInput').value) || 0;
    const prix = parseFloat(document.getElementById('prixInput').value) || 0;
    const prixTotal = nombre * prix;
    
    const prixTotalDiv = document.getElementById('prix-total');
    const prixTotalValue = document.getElementById('prix-total-value');
    
    if (prixTotal > 0) {
        prixTotalValue.textContent = prixTotal.toLocaleString('fr-FR', {minimumFractionDigits: 2});
        prixTotalDiv.style.display = 'block';
    } else {
        prixTotalDiv.style.display = 'none';
    }
}

function updateBandeInfo(bandeId) {
    const select = document.querySelector('select[name="bande_id"]');
    const selectedOption = select.options[select.selectedIndex];
    const bandeInfo = document.getElementById('bande-info');
    
    if (bandeId && selectedOption.dataset.nom) {
        bandeInfo.innerHTML = `
            <strong>Bande s√©lectionn√©e:</strong> ${selectedOption.dataset.nom}<br>
            <strong>Race:</strong> ${selectedOption.dataset.race}<br>
            <strong>Animaux initiaux:</strong> ${selectedOption.dataset.initial}<br>
            <strong>Animaux ajout√©s:</strong> ${selectedOption.dataset.ajoute}<br>
            <strong>Statut:</strong> <span class="status-badge status-${selectedOption.dataset.statut}">${selectedOption.dataset.statut}</span>
        `;
        bandeInfo.style.display = 'block';
    } else {
        bandeInfo.style.display = 'none';
    }
}

function togglePrixField() {
    const etatAchat = document.querySelector('select[name="etat_achat"]').value;
    const prixField = document.getElementById('prixField');
    const prixInput = document.getElementById('prixInput');
    
    if (etatAchat === 'n√©') {
        prixField.style.opacity = '0.6';
        prixInput.disabled = true;
        prixInput.value = '0';
    } else {
        prixField.style.opacity = '1';
        prixInput.disabled = false;
    }
    calculerPrixTotal();
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    debug('=== PAGE CHARG√âE ===');
    
    // √âcouteurs d'√©v√©nements pour les boutons de fonction
    document.getElementById('btn-ajouter').addEventListener('click', function() {
        debug('Bouton ajouter cliqu√©');
        showSection('ajouter');
    });
    
    document.getElementById('btn-liste').addEventListener('click', function() {
        debug('Bouton liste cliqu√©');
        loadListeAnimaux();
    });
    
    document.getElementById('btn-par-bande').addEventListener('click', function() {
        debug('Bouton par_bande cliqu√©');
        loadAnimauxParBande();
    });
    
    document.getElementById('btn-statistiques').addEventListener('click', function() {
        debug('Bouton statistiques cliqu√©');
        loadStatistiques();
    });
    
    document.getElementById('btn-rechercher').addEventListener('click', function() {
        debug('Bouton rechercher cliqu√©');
        showSection('rechercher');
    });
    
    // Test automatique (optionnel)
    setTimeout(testSections, 1000);
    
    // Initialisation
    showSection('ajouter');
    togglePrixField();
    
    // Autres √©couteurs
    document.getElementById('nombreInput').addEventListener('input', calculerPrixTotal);
    document.getElementById('prixInput').addEventListener('input', calculerPrixTotal);
    document.querySelector('select[name="etat_achat"]').addEventListener('change', togglePrixField);
    
    document.getElementById('searchAnimalInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchAnimaux();
        }
    });
    
    const dateInput = document.getElementById('dateNaissanceInput');
    if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    debug('Initialisation termin√©e');
});

// Les autres fonctions (showAnimalDetails, loadBandeStatistiques, exportAnimauxToExcel, editAnimal, deleteAnimal, closeEditModal) restent inchang√©es...
function showAnimalDetails(animalId) {
    debug('showAnimalDetails pour ID: ' + animalId);
    // ... le code existant
}

function loadBandeStatistiques(bandeId) {
    debug('loadBandeStatistiques pour bande: ' + bandeId);
    // ... le code existant
}

function exportAnimauxToExcel() {
    debug('exportAnimauxToExcel');
    // ... le code existant
}

function editAnimal(animalId) {
    debug('editAnimal: ' + animalId);
    alert('√âdition de l\\'animal ID: ' + animalId + ' - Fonction √† impl√©menter');
}

function deleteAnimal(animalId) {
    debug('deleteAnimal: ' + animalId);
    if (confirm('Supprimer cet animal ?')) {
        fetch(`/animaux/${animalId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        }).catch(error => {
            alert('Erreur: ' + error.message);
        });
    }
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}
</script>
{% endblock %}